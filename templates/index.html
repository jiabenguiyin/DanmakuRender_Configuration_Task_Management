<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>直播配置任务管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        #tagsContainer .badge {
            background-color: #4a5568 !important; /* 深灰色背景 */
            color: white !important;
            margin-right: 5px;
        }
        #tagsContainer .badge .text-danger {
            color: #fed7d7 !important; /* 浅红色删除按钮 */
            cursor: pointer;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>📋 配置任务管理界面</h2>

        <!-- 添加任务表单 -->
        <form method="POST" action="/add" class="row g-3 mt-4 mb-4">
            <div class="col-md-3">
                <select name="filename" class="form-control">
                    {% for file in yml_files %}
                        <option value="{{ file }}">{{ file }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <input name="start" type="date" class="form-control" required>
            </div>
            <div class="col-md-3">
                <input name="end" type="date" class="form-control" required>
            </div>
            <div class="col-md-3">
                <div class="row g-2">
                    <div class="col-6">
                        <button class="btn btn-primary w-100">➕ 添加任务</button>
                    </div>
                    <div class="col-6">
                        <button type="button" class="btn btn-secondary w-100" 
                                data-bs-toggle="modal" data-bs-target="#templateModal">
                            ➕ 新建模板
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <!-- 任务列表 -->
        <table class="table table-bordered table-hover">
            <thead class="table-light">
                <tr>
                    <th>配置文件</th>
                    <th>开始日期</th>
                    <th>结束日期</th>
                    <th>当前状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for task in schedule %}
                <tr>
                    <td>{{ task.filename }}</td>
                    <td>{{ task.start }}</td>
                    <td>{{ task.end }}</td>
                    <td>
                        {% if task.status == '启用中' %}
                            <span class="text-success">{{ task.status }}</span>
                        {% else %}
                            <span class="text-danger">{{ task.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editModal"
                                data-filename="{{ task.filename }}" data-start="{{ task.start }}" data-end="{{ task.end }}">
                            编辑
                        </button>
                        <a class="btn btn-sm btn-info" href="/toggle_task/{{ task.filename }}">
                            {% if task.status == '启用中' %}
                                禁用
                            {% else %}
                                启用
                            {% endif %}
                        </a>
                        <a class="btn btn-sm btn-danger" href="/delete/{{ task.filename }}">删除</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modal 新建直播间模板 -->
    <div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="templateModalLabel">新建直播间模板</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="/create_template">
                        <div class="mb-3">
                            <label for="taskname" class="form-label">请输入主播名</label>
                            <input type="text" name="taskname" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="url" class="form-label">请输入直播间链接</label>
                            <input type="text" name="url" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="tag" class="form-label">标签</label>
                            <input type="text" name="tag" class="form-control tag-input" id="tagInput" placeholder="请输入标签后回车">
                            <div id="tagsContainer" class="mt-2">
                                <span class="badge bg-light me-1">直播录像</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="is_repost" class="form-label">是否为转载</label>
                            <input type="checkbox" name="is_repost">
                        </div>
                        <button type="submit" class="btn btn-primary">保存模板</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 标签添加和删除功能
        const tagInput = document.getElementById('tagInput');
        const tagsContainer = document.getElementById('tagsContainer');

        tagInput.addEventListener('keydown', function(event) {
            // 阻止回车时表单提交
            if (event.key === 'Enter' && tagInput.value.trim() !== '') {
                event.preventDefault();  // 阻止表单提交
                const tag = tagInput.value.trim();
                addTag(tag);
                tagInput.value = '';
            }
        });

        function addTag(tag) {
            const tagDiv = document.createElement('div');
            tagDiv.classList.add('badge', 'bg-light', 'me-1');
            tagDiv.innerHTML = `${tag} <span class="text-danger" onclick="removeTag(this)">×</span>`;
            tagsContainer.appendChild(tagDiv);
        }

        function removeTag(tagElement) {
            tagsContainer.removeChild(tagElement.parentElement);
        }
    </script>
</body>
</html>
